# system-prompt 側の改善提案（ゲーム性を考慮した版）

<br />

## 前提条件

ゲーム性を保つため、AI は以下の制約で動作します：

- **知っている情報**：スタート位置、オブジェクトの位置、通常セルの位置
- **知らない情報**：ゴールの位置、トラップの位置

この制約により、ユーザーの指示は「安全なルートを知っている案内人」として扱われる必要があります。

<br />

## 背景

現在の `ai-route-prompt.js` では以下のような指示が含まれています：

```javascript
export const routePrompt = `
    1. 下のオブジェクトまで進んでください。
    2. 右に１マス進めます。
    3. 下に１マス進めます。
    4. 右に４マス進んでください。
`;
```

AI はトラップやゴールの位置を知らないため、ユーザーの指示から暗黙的な情報を読み取り、適切に解釈する必要があります。

<br />

## 現在の system-prompt の分析

### 良い点

1. **マップレイアウトの提供**
   - マップの完全な配列データが提供されている
   - 各行が明確に表示されている

2. **移動キーの定義**
   - 移動方向と対応する文字が明確

3. **セルタイプの説明**
   - 各セルタイプの意味が説明されている

### 改善が必要な点

1. **ユーザーの指示を信頼する姿勢の不足**
   - ユーザーがマップ全体を見ており、安全なルートを知っているという前提が明確でない
   - 指示に含まれる暗黙的な情報（トラップ回避など）を理解する説明がない

2. **限定的な情報での推論方法の不足**
   - 見えている情報（オブジェクトの位置）を手がかりにする方法が不明確
   - ユーザーの指示の意図を推測する指針がない

3. **段階的な指示の解釈方法の不足**
   - 各ステップがなぜその順序なのかを理解する視点がない
   - 指示の背後にある「見えない障害物の回避」を認識する説明がない

<br />

## 改善案

### 1. ユーザーを「案内人」として認識する機能を追加

```javascript
// generateSystemPrompt 関数内に追加
prompt +=
    `\n【ユーザーの役割の理解】\n` +
    `重要：ユーザーはマップ全体（トラップやゴールの位置を含む）を見ることができます。\n` +
    `ユーザーの指示は、あなたには見えない危険を回避し、ゴールへ導くための信頼できるガイドです。\n` +
    `指示が一見遠回りに見えても、それはトラップを避けるためかもしれません。\n` +
    `ユーザーの指示に忠実に従ってください。\n` +
    `\n`;
```

### 2. 見える情報を活用した指示の解釈

```javascript
prompt +=
    `\n【限定的な情報での指示解釈】\n` +
    `あなたが認識できる情報（オブジェクトの位置など）を手がかりに指示を解釈してください：\n` +
    `- 「下のオブジェクトまで」→ 現在位置から下方向にある、認識可能な最も近いオブジェクトを特定\n` +
    `- 「右に1マス」→ その位置から正確に1マス右へ\n` +
    `\n` +
    `注意：指示の順序には意味があります。直線的でない経路は、見えない障害物を避けている可能性があります。\n` +
    `\n`;
```

### 3. 段階的指示の意図を理解する機能

```javascript
prompt +=
    `\n【段階的な指示の解釈】\n` +
    `番号付きの指示がある場合：\n` +
    `1. 各ステップは前のステップの終了位置から開始\n` +
    `2. 指示の順序は重要 - 変更してはいけません\n` +
    `3. 「進めます」「進んでください」などの表現の違いは無視し、移動指示として統一的に解釈\n` +
    `\n` +
    `例：もし「下に2マス、右に1マス、下に3マス」という指示なら、\n` +
    `単純に「下に5マス」とまとめず、指定された順序通りに移動してください。\n` +
    `この順序は見えない障害物を避けるためかもしれません。\n` +
    `\n`;
```

### 4. 暗黙的な情報の読み取り

```javascript
prompt +=
    `\n【指示に含まれる暗黙的な情報】\n` +
    `ユーザーの指示から以下を推測してください：\n` +
    `- 特定の順序での移動 → その経路上に障害物がない\n` +
    `- 迂回するような指示 → 直線経路上に障害物がある可能性\n` +
    `- オブジェクトを目印にした指示 → そのオブジェクトまでは安全\n` +
    `\n` +
    `ユーザーはあなたを安全にゴールまで導こうとしています。\n` +
    `\n`;
```

### 5. 推論と実行のバランス

```javascript
prompt +=
    `\n【実行時の心構え】\n` +
    `1. ユーザーの指示を信頼し、正確に実行する\n` +
    `2. 見える情報（オブジェクトの位置）を活用して指示を解釈\n` +
    `3. 指示の背後にある意図（障害物回避）を意識する\n` +
    `4. しかし、指示されていない「最適化」は行わない\n` +
    `\n` +
    `最終的な応答は移動文字列のみとしてください。\n`;
```

<br />

## 実装例

改善版の `generateSystemPrompt` 関数への追加部分：

```javascript
export function generateSystemPrompt(mapConfig) {
    let prompt = '';
    
    // 既存のプロンプト生成コード...
    
    // 改善1: ユーザーの役割を明確化
    prompt +=
        `\n【ユーザーの役割の理解】\n` +
        `重要：ユーザーはマップ全体（トラップやゴールの位置を含む）を見ることができます。\n` +
        `ユーザーの指示は、あなたには見えない危険を回避し、ゴールへ導くための信頼できるガイドです。\n` +
        `\n`;
    
    // 改善2: 認識可能なオブジェクトの活用
    const visibleObjects = [];
    for (let j = 0; j < mapConfig.layout.length; j++) {
        for (let i = 0; i < mapConfig.layout[j].length; i++) {
            const cellType = mapConfig.cell[mapConfig.layout[j][i]]?.type;
            if (cellType === 'object') {
                visibleObjects.push(`(${i}, ${j})`);
            }
        }
    }
    
    if (visibleObjects.length > 0) {
        prompt +=
            `\n【認識可能なオブジェクトの位置】\n` +
            `あなたが認識できるオブジェクトは以下の位置にあります：\n` +
            `${visibleObjects.join(', ')}\n` +
            `これらを目印として、ユーザーの指示を解釈してください。\n` +
            `\n`;
    }
    
    // 改善3: 指示解釈のガイドライン
    prompt +=
        `\n【指示解釈の重要な原則】\n` +
        `1. ユーザーの指示の順序を守る（障害物回避のため）\n` +
        `2. 「〜まで」という表現は、認識可能な位置への移動を意味する\n` +
        `3. 一見非効率な経路も、見えない危険を避けるための最適解\n` +
        `4. 指示を「最適化」せず、忠実に実行する\n` +
        `\n`;
    
    return prompt;
}
```

<br />

## 期待される効果

これらの改善により：

1. **信頼関係に基づく協調動作**
   - AI がユーザーを「全体を見渡せる案内人」として認識
   - 指示の背後にある意図（障害物回避）を理解

2. **限定的情報での適切な判断**
   - 見える情報（オブジェクトの位置）を最大限活用
   - 見えない情報（トラップ）の存在を前提とした慎重な解釈

3. **ゲーム性の維持**
   - AI が全知全能ではなく、ユーザーの助けが必要
   - 協力してゴールを目指すという体験の実現

4. **柔軟で正確な指示解釈**
   - 「下のオブジェクトまで」のような自然な表現を理解
   - 段階的な指示の意図（迂回ルート）を尊重

<br />

## まとめ

ゲーム性を保ちながら ai-route-prompt の指示を適切に処理するには、AI に「限定的な情報しか持たない探索者」としての役割を明確に伝えることが重要です。ユーザーを信頼できる案内人として位置づけ、指示の背後にある「見えない危険の回避」という意図を理解させることで、曖昧な指示でも適切な動作が可能になります。

この改善により、AI とユーザーの協調的なゲームプレイが実現し、より魅力的な体験を提供できるようになります。