# 指標ベース指示が動作しない問題の分析

## 1. 問題の概要

数値指示を無効化する修正を行った結果、本来動作すべき指標ベースの指示も動作しなくなってしまった。

```
1. スタートから、オブジェクトまでまっすぐ下に進みます。
2. 右に端まで真っ直ぐ進みます。
3. 端まで到達したら、下に進むとゴールです。
```

<br />

## 2. 原因の分析

### 2.1. 過度に厳格な制約

現在のプロンプトでは以下の問題がある：

1. **最優先制約が強すぎる**
   - 「目印が存在しない方向への移動は不可能」という制約
   - しかし、「端」や「ゴール」は目印として明示的に定義されていない可能性

2. **「端」の解釈問題**
   - 「端まで進む」という指示に対して、「端」が目印として認識されない
   - マップの境界（端）は、objectタイプではないため、認識可能な目印として扱われていない可能性

3. **ゴールへの移動**
   - 「下に進むとゴールです」という指示で、ゴール（end タイプ）は「位置は認識できません」と定義されている
   - そのため、ゴールへの移動が不可能と判断される

### 2.2. セルタイプの定義との矛盾

現在のセルタイプ定義：
- `start`: 位置は認識できます
- `end`: 位置は認識できません ← これが問題
- `object`: 位置は認識できます
- `normal`: 位置は認識できます

「端」や「壁」は明示的なセルタイプとして定義されていない。

<br />

## 3. 解決策

### 3.1. 目印の定義を拡張

1. **認識可能な目印の明確化**
   - オブジェクト（object タイプ）
   - マップの端・境界
   - 壁（通行不可能なセル）
   - 経路の終端

2. **方向性のある移動の許可**
   - 「端まで」「壁まで」「行き止まりまで」は有効な指示として認識
   - これらは具体的なセルタイプでなくても、移動の終点として機能

### 3.2. 制約の調整

1. **最優先制約の緩和**
   - 「認識可能な目印」の定義を拡張
   - マップの物理的な境界も目印として扱う

2. **移動可能条件の明確化**
   - 「端」「壁」「行き止まり」への移動を明示的に許可
   - ゴールの方向への移動も、最終ステップとして許可

<br />

## 4. 実装方針

1. 「認識可能な目印」の定義を拡張し、マップの境界や壁も含める
2. 最優先制約を調整し、物理的な境界への移動を許可
3. 「端まで」「壁まで」などの指示を有効な形式として明記
4. ゴールへの最終移動を特別なケースとして扱う