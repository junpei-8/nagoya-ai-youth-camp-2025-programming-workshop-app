# 数値指示が依然として機能してしまう問題の分析

## 1. 問題の概要

現在のシステムプロンプトの修正にも関わらず、以下のような数値ベースの指示が正確に動作してしまっている。

```
1. スタートから、４マス真っ直ぐ下に進んでください。
2. 右に１マス進めます。
3. 下に１マス進めます。
4. 右に４マス真っ直ぐ進むとゴールになります。
```

<br />

## 2. 原因の分析

### 2.1. 現在のプロンプトの問題点

1. **矛盾する指示の存在**
   - 一方で「数値を無視せよ」と指示している
   - もう一方で「指示に忠実に従え」と指示している
   - AIは「忠実に従う」を優先して数値を解釈している可能性

2. **数値処理の代替案が不明確**
   - 「数値を無視して目印まで移動」という指示はあるが、目印がない場合の処理が不明確
   - マップに目印が少ない場合、AIは数値に頼らざるを得ない

3. **プロンプトの優先順位が不明確**
   - 複数のセクションで異なる指示があり、どれを優先すべきか明確でない

### 2.2. AIの学習データの影響

- AIは基本的に「Nマス進む」という指示を理解する能力を持っている
- この能力を完全に無効化するには、より強力な制約が必要

<br />

## 3. 解決策

### 3.1. より明確な制約の追加

1. **数値を含む指示への応答を明確に定義**
   - 数値を含む指示に対して、特定のエラーメッセージを返すよう指示
   - または、最小限の移動（1マスのみ）に制限

2. **プロンプトの階層構造を明確化**
   - 最優先事項として「数値指示の無効化」を配置
   - 他の指示より優先されることを明記

### 3.2. 具体的な実装案

1. **新しいセクション「最優先制約」を追加**
   - プロンプトの最初に配置
   - 数値による移動は不可能であることを強調

2. **移動可能な条件を限定**
   - 移動は必ず「認識可能な目印」に基づく必要があることを明記
   - 目印がない方向への移動は不可とする

3. **数値を含む指示への標準応答を定義**
   - 「その方向には認識可能な目印がないため移動できません」
   - または最小限の移動（1マスのみ）

<br />

## 4. 実装方針

1. generateSystemPrompt関数の最初に「最優先制約」セクションを追加
2. 各セクションで数値指示に関する記述を統一
3. 移動の前提条件として「目印の存在」を必須とする
4. テスト用の具体例を追加して、数値指示が機能しないことを示す